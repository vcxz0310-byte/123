<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‰´ìŠ¤ ìš”ì•½ ì±—ë´‡ (index3)</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --navy: #1e3a5f;
      --navy-light: #2c5282;
      --green: #2d8a5e;
      --green-light: #38a169;
      --green-bg: #f0fdf4;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-500: #64748b;
      --gray-700: #334155;
      --gray-900: #0f172a;
    }
    * { box-sizing: border-box; }
    body {
      background: #f8fafc;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 32px 0 48px;
      color: var(--gray-900);
      -webkit-font-smoothing: antialiased;
    }
    .main-container { max-width: 1100px; margin: 0 auto; padding: 0 28px; }
    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--navy);
      text-align: center;
      margin-bottom: 40px;
      letter-spacing: -0.02em;
    }
    .page-title .accent { color: var(--green); }
    .section-card {
      background: var(--white);
      border-radius: 14px;
      border: 1px solid var(--gray-200);
      padding: 28px 32px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .section-card:hover { border-color: var(--gray-200); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      letter-spacing: -0.01em;
    }
    .model-tag {
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--gray-500);
      background: var(--gray-100);
      padding: 5px 12px;
      border-radius: 100px;
      letter-spacing: 0.02em;
    }
    .form-label { color: var(--gray-700); font-weight: 500; font-size: 0.875rem; margin-bottom: 8px; }
    .api-key-input {
      font-family: "SF Mono", "Consolas", monospace;
      font-size: 0.875rem;
      border-radius: 10px;
      border: 1px solid var(--gray-200);
      padding: 12px 16px;
      background: var(--white);
      color: var(--gray-900);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .api-key-input::placeholder { color: var(--gray-500); }
    .api-key-input:focus {
      border-color: var(--green);
      outline: none;
      box-shadow: 0 0 0 3px rgba(45,138,94,0.15);
    }
    .validation-result {
      padding: 14px 18px;
      border-radius: 10px;
      margin-top: 14px;
      font-size: 0.875rem;
      line-height: 1.5;
      border: 1px solid transparent;
    }
    .validation-success {
      background: var(--green-bg);
      border-color: rgba(45,138,94,0.3);
      color: #166534;
    }
    .validation-error {
      background: #fef2f2;
      border-color: rgba(239,68,68,0.25);
      color: #b91c1c;
    }
    .article-card {
      border-radius: 10px;
      border: 1px solid var(--gray-200);
      padding: 16px 18px;
      margin-bottom: 12px;
      background: var(--gray-50);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .article-card:hover {
      border-color: var(--gray-200);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .article-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--navy); }
    .article-title a { color: var(--green); text-decoration: none; }
    .article-title a:hover { color: var(--green-light); text-decoration: underline; }
    .article-meta { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 8px; }
    .article-summary { font-size: 0.85rem; color: var(--gray-700); line-height: 1.55; }
    .chat-wrap {
      position: relative;
      min-height: 340px;
      height: 500px;
      max-height: 78vh;
      resize: vertical;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      background: #b2c7d9;
    }
    .chat-container {
      height: 100%;
      overflow-y: auto;
      padding: 16px;
      margin-bottom: 0;
    }
    .chat-container::-webkit-scrollbar { width: 6px; }
    .chat-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.06); border-radius: 3px; }
    .chat-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
    .message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 18px;
      word-wrap: break-word;
      line-height: 1.5;
      font-size: 0.9rem;
      display: block;
      width: fit-content;
      max-width: 78%;
    }
    .message.user {
      background: #ffe812;
      color: #191919;
      margin-left: auto;
      text-align: right;
      border-bottom-right-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .message.bot {
      background: var(--white);
      color: #191919;
      margin-right: auto;
      border: none;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .summary-box {
      background: var(--green-bg);
      border-radius: 12px;
      border: 1px solid rgba(45,138,94,0.2);
      padding: 20px 22px;
      margin-bottom: 20px;
    }
    .summary-box h6 { color: var(--navy); margin-bottom: 10px; font-weight: 600; }
    .summary-box #summary-content { color: var(--gray-700); line-height: 1.6; }
    .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 1024px) { .grid-layout { grid-template-columns: 1fr; } }
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 8px;
    }
    .status-ready { background: var(--green-bg); color: var(--green); }
    .status-waiting { background: transparent; color: var(--navy); }
    .btn-primary {
      background: var(--green);
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--white);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .btn-primary:hover {
      background: var(--green-light);
      box-shadow: 0 4px 12px rgba(45,138,94,0.3);
    }
    .btn-secondary {
      background: var(--white);
      border: 1px solid var(--gray-200);
      color: var(--gray-700);
      border-radius: 10px;
      padding: 8px 16px;
      font-weight: 500;
    }
    .btn-secondary:hover { background: var(--gray-50); border-color: var(--gray-200); color: var(--navy); }
    .btn-info { background: #eff6ff; border: 1px solid #bfdbfe; color: var(--navy-light); border-radius: 8px; }
    .btn-info:hover { background: #dbeafe; color: var(--navy); }
    .btn-success { background: var(--green-bg); border: 1px solid rgba(45,138,94,0.3); color: var(--green); border-radius: 8px; }
    .btn-success:hover { background: #dcfce7; color: var(--green-light); }
    .form-control {
      border-radius: 10px;
      border: 1px solid var(--gray-200);
      padding: 12px 16px;
      background: var(--white);
      color: var(--gray-900);
      font-size: 0.9rem;
    }
    .form-control::placeholder { color: var(--gray-500); }
    .form-control:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(45,138,94,0.12);
      outline: none;
    }
    .text-muted { color: var(--gray-500) !important; }
    .alert-danger {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      border-radius: 10px;
    }
    .saved-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .saved-item-left { flex: 1; min-width: 0; }
    .saved-keyword { font-size: 1rem; font-weight: 600; color: var(--navy); margin-bottom: 4px; }
    .saved-meta { font-size: 0.8rem; color: var(--gray-500); }
    .saved-delete {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      color: var(--gray-500);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .saved-delete:hover { background: #fef2f2; color: #b91c1c; }
    .badge.bg-primary { background: var(--green) !important; }
    .badge.bg-secondary { background: var(--gray-200) !important; color: var(--gray-700); }
    #chat-loading { color: var(--green); font-weight: 500; }
  </style>
</head>
<body>
  <div class="main-container">
    <h1 class="page-title">â–¸ ë‰´ìŠ¤ ìš”ì•½ <span class="accent">ì±—ë´‡</span></h1>

    <div class="section-card">
      <div class="section-title">
        â–¸ ì¬ë¯¸ë‚˜ì´(Gemini) API í‚¤ ì„¤ì •
        <span class="model-tag" id="model-tag">ì‚¬ìš© ëª¨ë¸: Gemini 2.5 Flash</span>
      </div>
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label class="form-label">API í‚¤ ì…ë ¥</label>
          <input type="text" class="form-control api-key-input" id="api-key-input" placeholder="AIzaSyD3a5aGRqW9nOM_WVqCuTmr7d6fDkf9HyY" value="" autocomplete="off" />
        </div>
        <div class="col-md-4">
          <button type="button" class="btn btn-primary w-100" onclick="validateAndSaveApiKey()">ê²€ì¦ ë° ì €ì¥</button>
        </div>
      </div>
      <div id="api-validation-result"></div>
    </div>

    <div class="section-card">
      <div class="section-title">â–¸ ë‰´ìŠ¤ ê²€ìƒ‰ <span id="news-status" class="status-badge status-waiting">ëŒ€ê¸° ì¤‘</span></div>
      <form id="search-form" class="row g-2 mb-3">
        <div class="col-md-9">
          <input type="text" class="form-control" id="search-keyword" placeholder="" required />
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100" id="search-btn">ë‰´ìŠ¤ ê²€ìƒ‰</button>
        </div>
      </form>
      <div id="search-error" class="alert alert-danger" style="display: none;"></div>
      <div id="summary-box" class="summary-box" style="display: none;">
        <h6 class="fw-bold mb-2">â–¸ AI ìš”ì•½</h6>
        <div id="summary-content"></div>
      </div>
      <div id="articles-container"></div>
      <div id="action-buttons" style="display: none; margin-top: 12px;">
        <button type="button" class="btn btn-sm btn-info me-2" onclick="generateSummary()">ğŸ“ AI ìš”ì•½ ìƒì„±</button>
        <button type="button" class="btn btn-sm btn-success" onclick="saveCurrentNews()">ğŸ’¾ ë‰´ìŠ¤ ì €ì¥í•˜ê¸°</button>
      </div>
    </div>

    <div class="grid-layout">
      <div class="section-card">
        <div class="section-title">â–¸ ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ëª©ë¡</div>
        <div id="articles-list" class="text-muted">ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
      <div class="section-card">
        <div class="section-title">â–¸ ë‰´ìŠ¤ ëŒ€í™” <span id="chat-status" class="status-badge status-waiting">ëŒ€ê¸° ì¤‘</span></div>
        <div class="chat-wrap" title="ì•„ë˜ ëª¨ì„œë¦¬ë¥¼ ë“œë˜ê·¸í•´ ë†’ì´ ì¡°ì ˆ">
          <div class="chat-container" id="chat-messages">
          <div class="message bot">
            ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•œ í›„ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.
          </div>
        </div>
        </div>
        <form id="chat-form" class="row g-2 mt-2">
          <div class="col-md-9">
            <input type="text" class="form-control" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥" required />
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">ì „ì†¡</button>
          </div>
        </form>
        <div id="chat-loading" style="display: none; text-align: center; padding: 10px;">ë‹µë³€ ìƒì„± ì¤‘...</div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title">â–¸ ì €ì¥ëœ ë‰´ìŠ¤</div>
      <button type="button" class="btn btn-sm btn-secondary mb-3" onclick="loadSavedNews()">ìƒˆë¡œê³ ì¹¨</button>
      <div id="saved-news-list"><div class="text-muted">ì €ì¥ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>
    </div>
  </div>

  <script>
    var GEMINI_MODEL = "gemini-2.5-flash";
    var DEFAULT_API_KEY = "AIzaSyD3a5aGRqW9nOM_WVqCuTmr7d6fDkf9HyY";
    var STORAGE_KEY = "news_chatbot_api_key";
    var STORAGE_SAVED = "news_chatbot_saved_index3";
    var PROXY = "https://api.allorigins.win/raw?url=";

    var currentArticles = [];
    var currentKeyword = "";

    function getApiKey() {
      try {
        return localStorage.getItem(STORAGE_KEY) || "";
      } catch (e) { return ""; }
    }
    function setApiKey(key) {
      try { localStorage.setItem(STORAGE_KEY, key); return true; } catch (e) { return false; }
    }

    function simpleSummarizeText(text, maxSentences) {
      if (!text) return "(ìš”ì•½í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.)";
      var tmp = document.createElement("div");
      tmp.innerHTML = text;
      var cleaned = (tmp.textContent || tmp.innerText || "").replace(/\s+/g, " ").replace(/&nbsp;/g, " ").trim();
      if (!cleaned) return "(ìš”ì•½í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.)";
      var sentences = [];
      var current = "";
      for (var i = 0; i < cleaned.length; i++) {
        current += cleaned[i];
        if (/[.?!ï¼Ÿï¼]/.test(cleaned[i]) || (cleaned[i] === "ë‹¤") || (cleaned[i] === "ìš”")) {
          if (current.trim()) { sentences.push(current.trim()); current = ""; }
        }
      }
      if (current.trim()) sentences.push(current.trim());
      if (sentences.length === 0) return cleaned;
      return sentences.slice(0, maxSentences || 2).join(" ");
    }

    async function callGemini(apiKey, prompt) {
      var url = "https://generativelanguage.googleapis.com/v1beta/models/" + GEMINI_MODEL + ":generateContent?key=" + encodeURIComponent(apiKey);
      var resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
        })
      });
      var data = await resp.json();
      if (data.error) {
        throw new Error(data.error.message || "API ì˜¤ë¥˜");
      }
      var text = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0];
      return text ? text.text : "";
    }

    function validateAndSaveApiKey() {
      var inputEl = document.getElementById("api-key-input");
      var apiKey = inputEl.value.trim();
      if (!apiKey) apiKey = (inputEl.getAttribute("placeholder") || DEFAULT_API_KEY).trim();
      var resultDiv = document.getElementById("api-validation-result");
      if (!apiKey) {
        resultDiv.innerHTML = '<div class="validation-result validation-error"><strong>âŒ API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</strong></div>';
        return;
      }
      if (!apiKey.startsWith("AIza")) {
        resultDiv.innerHTML = '<div class="validation-result validation-error"><strong>âŒ API í‚¤ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong> (AIzaë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤)</div>';
        return;
      }
      resultDiv.innerHTML = '<div class="validation-result" style="background:#f3f4f6;border:1px solid #9ca3af;"><strong>â³ ê²€ì¦ ì¤‘...</strong></div>';
      callGemini(apiKey, "í•œ ì¤„ë¡œ 'ì—°ê²°ë¨'ì´ë¼ê³ ë§Œ ë‹µí•´ì£¼ì„¸ìš”.")
        .then(function() {
          setApiKey(apiKey);
          resultDiv.innerHTML = '<div class="validation-result validation-success"><strong>âœ… API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤. ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></div>';
        })
        .catch(function(err) {
          resultDiv.innerHTML = '<div class="validation-result validation-error"><strong>âŒ ê²€ì¦ ì‹¤íŒ¨</strong><br><small>' + (err.message || "") + '</small></div>';
        });
    }

    document.getElementById("search-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      var keyword = document.getElementById("search-keyword").value.trim();
      if (!keyword) return;
      var searchBtn = document.getElementById("search-btn");
      var errorDiv = document.getElementById("search-error");
      var articlesContainer = document.getElementById("articles-container");
      var articlesList = document.getElementById("articles-list");
      var statusBadge = document.getElementById("news-status");
      searchBtn.disabled = true;
      errorDiv.style.display = "none";
      articlesContainer.innerHTML = "";
      articlesList.innerHTML = "";
      statusBadge.textContent = "ê²€ìƒ‰ ì¤‘...";
      statusBadge.className = "status-badge status-waiting";

      var rssUrl = "https://news.google.com/rss/search?q=" + encodeURIComponent(keyword) + "&hl=ko&gl=KR&ceid=KR:ko";
      var proxyUrl = PROXY + encodeURIComponent(rssUrl);
      try {
        var resp = await fetch(proxyUrl);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        var text = await resp.text();
        var parser = new DOMParser();
        var xml = parser.parseFromString(text, "application/xml");
        var items = Array.from(xml.getElementsByTagName("item")).slice(0, 10);
        if (items.length === 0) {
          statusBadge.textContent = "ë‰´ìŠ¤ë¥¼ ì°¾ì§€ ëª»í•¨";
          statusBadge.className = "status-badge status-waiting";
          articlesList.innerHTML = "<div class=\"text-muted\">ë‰´ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>";
          return;
        }
        currentArticles = [];
        items.forEach(function(item) {
          var title = (item.getElementsByTagName("title")[0] && item.getElementsByTagName("title")[0].textContent) || "(ì œëª© ì—†ìŒ)";
          var link = (item.getElementsByTagName("link")[0] && item.getElementsByTagName("link")[0].textContent) || "";
          var pubDate = (item.getElementsByTagName("pubDate")[0] && item.getElementsByTagName("pubDate")[0].textContent) || "";
          var desc = (item.getElementsByTagName("description")[0] && item.getElementsByTagName("description")[0].textContent) || "";
          currentArticles.push({ title: title, link: link, published: pubDate, summary: desc, summary_short: simpleSummarizeText(desc, 2) });
        });
        currentKeyword = keyword;
        statusBadge.textContent = currentArticles.length + "ê°œ ìˆ˜ì§‘ ì™„ë£Œ";
        statusBadge.className = "status-badge status-ready";
        var listHtml = "";
        currentArticles.forEach(function(article, idx) {
          listHtml += "<div class=\"article-card\"><div class=\"article-title\">" + (idx + 1) + ". " + (article.title || "(ì œëª© ì—†ìŒ)") + "</div>" + (article.published ? "<div class=\"article-meta\">" + article.published + "</div>" : "") + "</div>";
        });
        articlesList.innerHTML = listHtml;
        var detailHtml = "<p class=\"text-muted mb-2\">ì´ " + currentArticles.length + "ê°œ ê¸°ì‚¬</p>";
        currentArticles.forEach(function(article) {
          var titleHtml = article.link ? "<a href=\"" + article.link + "\" target=\"_blank\" rel=\"noopener\">" + (article.title || "") + "</a>" : (article.title || "");
          detailHtml += "<div class=\"article-card\"><div class=\"article-title\">" + titleHtml + "</div>" + (article.published ? "<div class=\"article-meta\">" + article.published + "</div>" : "") + "<div class=\"article-summary\">" + (article.summary_short || article.summary || "") + "</div></div>";
        });
        articlesContainer.innerHTML = detailHtml;
        document.getElementById("chat-status").textContent = currentArticles.length + "ê°œ ë‰´ìŠ¤ ì¤€ë¹„ë¨";
        document.getElementById("chat-status").className = "status-badge status-ready";
        document.getElementById("action-buttons").style.display = "block";
      } catch (err) {
        errorDiv.innerHTML = "<strong>ì˜¤ë¥˜</strong><br><small>" + (err.message || "ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.") + "</small>";
        errorDiv.style.display = "block";
        statusBadge.textContent = "ê²€ìƒ‰ ì‹¤íŒ¨";
        statusBadge.className = "status-badge status-waiting";
      } finally {
        searchBtn.disabled = false;
      }
    });

    function generateSummary() {
      if (currentArticles.length === 0) { alert("ìš”ì•½í•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      var apiKey = getApiKey();
      if (!apiKey) { alert("API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ê²€ì¦Â·ì €ì¥í•´ ì£¼ì„¸ìš”."); return; }
      var summaryBox = document.getElementById("summary-box");
      var summaryContent = document.getElementById("summary-content");
      summaryBox.style.display = "block";
      summaryContent.textContent = "ìš”ì•½ ìƒì„± ì¤‘...";
      var newsText = "";
      currentArticles.forEach(function(a, i) {
        newsText += "[ê¸°ì‚¬ " + (i + 1) + "] ì œëª©: " + (a.title || "") + "\në‚´ìš©: " + (a.summary || a.summary_short || "") + "\n\n";
      });
      var prompt = "ë‹¤ìŒ ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ì„ ì½ê³  ì „ì²´ì ì¸ ìš”ì•½ì„ í•œêµ­ì–´ë¡œ 3~5ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n" + newsText + "\nìš”ì•½:";
      callGemini(apiKey, prompt)
        .then(function(summary) {
          summaryContent.textContent = summary || "(ìš”ì•½ ì—†ìŒ)";
        })
        .catch(function(err) {
          summaryContent.textContent = "ì˜¤ë¥˜: " + (err.message || "ìš”ì•½ ìƒì„± ì‹¤íŒ¨");
        });
    }

    document.getElementById("chat-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      var input = document.getElementById("chat-input");
      var message = input.value.trim();
      if (!message) return;
      if (currentArticles.length === 0) { alert("ë¨¼ì € ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•´ ì£¼ì„¸ìš”."); return; }
      var apiKey = getApiKey();
      if (!apiKey) { alert("API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ê²€ì¦Â·ì €ì¥í•´ ì£¼ì„¸ìš”."); return; }
      var chatMessages = document.getElementById("chat-messages");
      var userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.textContent = message;
      chatMessages.appendChild(userMsg);
      input.value = "";
      document.getElementById("chat-loading").style.display = "block";
      var newsText = "";
      currentArticles.forEach(function(a, i) {
        newsText += "[ê¸°ì‚¬ " + (i + 1) + "] ì œëª©: " + (a.title || "") + "\në‚´ìš©: " + (a.summary || a.summary_short || "") + "\n\n";
      });
      var prompt = "ë‹¹ì‹ ì€ ë‰´ìŠ¤ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ì ì§ˆë¬¸ì—ë§Œ í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.\n\n" + newsText + "\nì‚¬ìš©ì ì§ˆë¬¸: " + message + "\n\në‹µë³€:";
      callGemini(apiKey, prompt)
        .then(function(response) {
          var botEl = document.createElement("div");
          botEl.className = "message bot";
          botEl.textContent = response || "(ë‹µë³€ ì—†ìŒ)";
          chatMessages.appendChild(botEl);
        })
        .catch(function(err) {
          var errEl = document.createElement("div");
          errEl.className = "message bot";
          errEl.textContent = "ì˜¤ë¥˜: " + (err.message || "ë‹µë³€ ìƒì„± ì‹¤íŒ¨");
          chatMessages.appendChild(errEl);
        })
        .finally(function() {
          document.getElementById("chat-loading").style.display = "none";
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    });

    function saveCurrentNews() {
      if (!currentKeyword || currentArticles.length === 0) { alert("ì €ì¥í•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      try {
        var saved = JSON.parse(localStorage.getItem(STORAGE_SAVED) || "[]");
        saved.push({
          keyword: currentKeyword,
          timestamp: new Date().toLocaleString("ko-KR"),
          articles: currentArticles
        });
        localStorage.setItem(STORAGE_SAVED, JSON.stringify(saved));
        alert("ë‰´ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        loadSavedNews();
      } catch (e) {
        alert("ì €ì¥ ì‹¤íŒ¨: " + (e.message || "ì•Œ ìˆ˜ ì—†ìŒ"));
      }
    }

    function deleteSavedNews(index) {
      try {
        var saved = JSON.parse(localStorage.getItem(STORAGE_SAVED) || "[]");
        if (index < 0 || index >= saved.length) return;
        saved.splice(index, 1);
        localStorage.setItem(STORAGE_SAVED, JSON.stringify(saved));
        loadSavedNews();
      } catch (e) { console.error(e); }
    }

    function loadSavedNews() {
      var listEl = document.getElementById("saved-news-list");
      try {
        var saved = JSON.parse(localStorage.getItem(STORAGE_SAVED) || "[]");
        if (saved.length === 0) {
          listEl.innerHTML = "<div class=\"text-muted\">ì €ì¥ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
          return;
        }
        var html = "";
        saved.forEach(function(item, idx) {
          var kw = (item.keyword || "").trim() || "ê²€ìƒ‰ì–´ ì—†ìŒ";
          var ts = item.timestamp || "";
          var n = item.articles ? item.articles.length : 0;
          html += "<div class=\"article-card mb-3 saved-item\"><div class=\"saved-item-left\"><div class=\"saved-keyword\">" + kw + "</div><div class=\"saved-meta\">" + ts + (n ? " Â· " + n + "ê°œ ê¸°ì‚¬" : "") + "</div></div><button type=\"button\" class=\"saved-delete\" onclick=\"deleteSavedNews(" + idx + ")\" title=\"ì‚­ì œ\">Ã—</button></div>";
        });
        listEl.innerHTML = html;
      } catch (e) {
        listEl.innerHTML = "<div class=\"text-danger\">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜</div>";
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      var savedKey = getApiKey();
      if (savedKey) document.getElementById("api-key-input").value = savedKey;
      loadSavedNews();
      document.getElementById("api-key-input").focus();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
